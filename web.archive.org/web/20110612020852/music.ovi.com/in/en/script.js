var database = {
    "top": [
      
        {
            "title": "Achacho",
            "artist": "Kharesma Ravichandran",
            "album": "Aranmanai 4",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/5950a826-b631-49e1-957a-dd0644712efc/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Achacho.mp3"
        },
        {
            "title": "Faded",
            "artist": "Alan Walker, Selena Gomez",
            "album": "Faded",
            "language": "Unknown",
            "cover": "https://upload.wikimedia.org/wikipedia/en/d/da/Alan_Walker_-_Faded.png",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Alan Walker Faded.mp3"
        },
        {
            "title": "Arima Arima",
            "artist": "Hariharan",
            "album": "Enthiran",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/6a984a13-5c87-4a10-b719-a1be76de3b6b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Arima-Arima.mp3"
        },
        {
            "title": "Azhagin Azhagu",
            "artist": "Sinduri Vishal",
            "album": "Sita Ramam (Tamil) (Extended Version) [Original Motion Picture Soundtrack]",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/9b7594dc-ea6d-4e11-bcf1-f8b7d178021b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Azhagin-Azhagu Sita Ramam.mp3"
        },
        {
            "title": "Boom Boom Robo Da",
            "artist": "Yogi B",
            "album": "Enthiran",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/6a984a13-5c87-4a10-b719-a1be76de3b6b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Boom-Boom-Robo-Da.mp3"
        },
        {
            "title": "Chennai Sentamizh",
            "artist": "Dandapani Desikar",
            "album": "M.Kumaran S/O Mahalakshmi",
            "language": "Unknown",
            "cover": "https://a10.gaanacdn.com/gn_img/albums/7rVW1aRWk5/rVW1qNEPWk/size_l_1596799370.webp",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Chennai-Sentamizh.mp3"
        },
        {
            "title": "Chuttamalle",
            "artist": "Shilpa Rao",
            "album": "Devara Part 1",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/dc6f2139-159d-42be-a97a-1688ebc09e43/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Chuttamalle.mp3"
        },
        {
            "title": "Hey Minnale",
            "artist": "G.V. Prakash Kumar",
            "album": "Amaran",
            "language": "Unknown",
            "cover": "https://upload.wikimedia.org/wikipedia/en/9/99/Amaran_%28soundtrack%29.png",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Hey-Minnale.mp3"
        },
        {
            "title": "Hey Sita Hey Rama",
            "artist": "S.P.B. Charan",
            "album": "Sita Ramam (Tamil) (Extended Version) [Original Motion Picture Soundtrack]",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/9b7594dc-ea6d-4e11-bcf1-f8b7d178021b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Hey-Sita-Hey-Rama Sita Ramam.mp3"
        },
        {
            "title": "Hukum – Thalaivar Alappara",
            "artist": "Anirudh Ravichander",
            "album": "Jailer",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/275532ec-0908-4caa-9448-1cffd293af56/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Hukum---Thalaivar-Alappara-MassTamilan.dev.mp3"
        },
        {
            "title": "Irumbile Oru Irudhaiyam",
            "artist": "A. R. Rahman",
            "album": "Enthiran",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/6a984a13-5c87-4a10-b719-a1be76de3b6b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Irumbile-Oru-Idhaiyam.mp3"
        },
        {
            "title": "Skyfall (From ''James Bond - Skyfall'')",
            "artist": "L’Orchestra Cinematique",
            "album": "The Greatest Hits of L'Orchestra Cinematique, Vol. 1",
            "language": "Unknown",
            "cover": "https://i.ytimg.com/vi/LJzp_mDxaT0/maxresdefault.jpg",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/James Bond - Skyfall.mp3"
        },
        {
            "title": "Kaalangal Thaandi",
            "artist": "Sinduri Vishal",
            "album": "Sita Ramam (Tamil) (Extended Version) [Original Motion Picture Soundtrack]",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/9b7594dc-ea6d-4e11-bcf1-f8b7d178021b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kaalangal-Thaandi Sita Ramam.mp3"
        },
        {
            "title": "Kadhal Anukkal",
            "artist": "Vijay Prakash",
            "album": "Enthiran",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/6a984a13-5c87-4a10-b719-a1be76de3b6b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kadal-Anukkal.mp3"
        },
        {
            "title": "Kannukulle",
            "artist": "Vishal Chandrasekhar",
            "album": "Sita Ramam (Extended Version)",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/ec71f732-357b-46f2-8dfb-70a566f90376/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kannukkulle Sita Ramam.mp3"
        },
        {
            "title": "Kilimanjaro",
            "artist": "-",
            "album": "Enthiran",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/6a984a13-5c87-4a10-b719-a1be76de3b6b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kilimanjaro.mp3"
        },
        {
            "title": "Kurchi Madathapetti",
            "artist": "Thaman S",
            "album": "Guntur Kaaram",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/8513347a-e591-42b3-bf79-da6a1b96dc4a/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kurchi Madathapetti.mp3"
        },
        {
            "title": "Kurukku Siruthavalae",
            "artist": "Hariharan",
            "album": "Mudhalvan",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/b9683866-a962-46e8-ab0a-3147214ee97d/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kurukku-Siruthavale.mp3"
        },
        {
            "title": "Kurumugil",
            "artist": "Vishal Chandrasekhar",
            "album": "Sita Ramam (Tamil) (Extended Version) [Original Motion Picture Soundtrack]",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/9b7594dc-ea6d-4e11-bcf1-f8b7d178021b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kurumugil Sita Ramam.mp3"
        },
        {
            "title": "Kurunchiragu",
            "artist": "Vishal Chandrasekhar",
            "album": "Sita Ramam (Extended Version)",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/ec71f732-357b-46f2-8dfb-70a566f90376/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Kurunchiragu Sita Ramam.mp3"
        },
        {
            "title": "Mundhinam Paartheney",
            "artist": "Naresh Iyer",
            "album": "Vaaranam Aayiram",
            "language": "Unknown",
            "cover": "https://c.saavncdn.com/635/Vaaranam-Aayiram-Tamil-2008-20190629141128-500x500.jpg",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Mundhinam-Parthene-MassTamilan.com.mp3"
        },
        {
            "title": "Nannare",
            "artist": "Shreya Ghoshal",
            "album": "Guru",
            "language": "Unknown",
            "cover": "https://m.media-amazon.com/images/I/71mXj-qnJCL._UF1000,1000_QL80_.jpg",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Nannare-Nannare.mp3"
        },
        {
            "title": "On & On",
            "artist": "Cartoon",
            "album": "Más Y Más On & On",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/c332076d-f074-4679-9d05-e3eb6822d6a8/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/On & On (Cartoon).mp3"
        },
        {
            "title": "Paththavaikkum",
            "artist": "Unknown",
            "album": "Devara - Tamil",
            "language": "Unknown",
            "cover": "https://speks.art/images/Front4461ca34012b82c4.md.png",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Paththavaikkum.mp3"
        },
        {
            "title": "Piriyadhey",
            "artist": "Vishal Chandrasekhar",
            "album": "Sita Ramam (Extended Version)",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/ec71f732-357b-46f2-8dfb-70a566f90376/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Piriyadhey Sita Ramam.mp3"
        },
        {
            "title": "Sita Ramam Theme (Tamil)",
            "artist": "Vishal Chandrasekhar",
            "album": "Sita Ramam (Tamil) (Extended Version) [Original Motion Picture Soundtrack]",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/9b7594dc-ea6d-4e11-bcf1-f8b7d178021b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Sita-Ramam-Theme-(Tamil)-MassTamilan.dev.mp3"
        },
        {
            "title": "Strawberry Kannae",
            "artist": "Febi Mani",
            "album": "Minsara Kanavu (Original Motion Picture Soundtrack)",
            "language": "Unknown",
            "cover": "https://pilanipictures.wordpress.com/wp-content/uploads/2022/01/mk-anavu-poster.jpg?w=1024",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Strawberry-Kannae.mp3"
        },
        {
            "title": "Cradles",
            "artist": "Sub Urban",
            "album": "Cradles",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/49d4417b-ff36-47c6-b3b4-315737377d86/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Sub Urban - Cradles.mp3"
        },
        {
            "title": "Thooda",
            "artist": "Vishal Chandrasekhar",
            "album": "Sita Ramam (Extended Version)",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/ec71f732-357b-46f2-8dfb-70a566f90376/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Thooda Sita Ramam.mp3"
        },
        {
            "title": "Uraiyum Theeyil",
            "artist": "Yazin Nizar",
            "album": "Sita Ramam (Tamil) (Extended Version) [Original Motion Picture Soundtrack]",
            "language": "Unknown",
            "cover": "https://coverartarchive.org/release/9b7594dc-ea6d-4e11-bcf1-f8b7d178021b/front",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Uraiyum-Theeyil Sita Ramam.mp3"
        },
        {
            "title": "Vennilavae Vennilavae",
            "artist": "S. P. Balasubrahmanyam",
            "album": "Minsara Kanavu",
            "language": "Unknown",
            "cover": "https://pilanipictures.wordpress.com/wp-content/uploads/2022/01/mk-anavu-poster.jpg?w=1024",
            "url": "https://raw.githubusercontent.com/anyosil/symmusic.github.io/main/music/M1/Vennilavae.mp3"
        }
    ]
};

document.addEventListener("DOMContentLoaded", function () {
    const loginButton = document.getElementById("lgn-btn");

    function updateLoginButton() {
        const loggedInUser = localStorage.getItem("loggedInUser");

        if (loggedInUser) {
            loginButton.textContent = `Signed In: ${loggedInUser}`;
            loginButton.onclick = function () {
                const confirmLogout = confirm(`Do you want to log out, ${loggedInUser}?`);
                if (confirmLogout) {
                    localStorage.removeItem("loggedInUser"); // Clear user session
                    updateLoginButton(); // Reset button text
                }
            };
        } else {
            loginButton.textContent = "Sign In";
            loginButton.onclick = function () {
                window.location.href = "register.html"; // Redirect to login page
            };
        }
    }

    updateLoginButton(); // Call on page load
});



const BIN_ID = "67cad3a7e41b4d34e4a257df";
const API_KEY = "$2a$10$IG0fCGUHCL7iFsZMFQjI4e4ufPung048BrnWjddZBoo5V3UjUQ4ja";

let currentSongIndex = 0;
let currentSection = "top";
let audioPlayer = new Audio(); // Persistent audio player





// 🚀 Populate Featured Music Section
function populateFeaturedMusic() {
    const featuredSections = ["top", "nice", "m_l", "Other"];

    featuredSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (!section) return console.error(`❌ Section ${sectionId} not found`);

        section.innerHTML = ""; // ✅ Clear old content before inserting new songs
        const songs = database[sectionId] || [];
        if (songs.length === 0) {
            section.innerHTML = `<p class="no-songs">No songs available</p>`;
            return;
        }

        const ul = document.createElement("ul");
        ul.classList.add("music-grid");

        songs.forEach((song, index) => {
            const songCover = song.cover || "default-cover.jpg";

            const li = document.createElement("li");
            li.classList.add("music-tile");

            // ✅ Move data attributes to <li> (Fixes song URL missing issue)
            li.setAttribute("data-index", index);
            li.setAttribute("data-section", sectionId);
            li.setAttribute("data-title", song.title);
            li.setAttribute("data-artist", song.artist || "Unknown Artist");
            li.setAttribute("data-cover", songCover);
            li.setAttribute("data-url", song.url || "");

            li.innerHTML = `
                <div class="song-card">
                    <img src="${songCover}" alt="${song.title}" onerror="this.src='default-cover.jpg';">
                    <div class="song-info">
                        <strong>${song.title}</strong>
                        <p>${song.artist || 'Unknown Artist'}</p>
                    </div>
                </div>
            `;

            li.addEventListener("click", playSongHandler); // 🔥 Clickable tile
            ul.appendChild(li);
        });

        section.appendChild(ul);
    });
}

// 🎵 Play Song Handler
function playSongHandler(event) {
    let li = event.target.closest("li"); // 🔥 Ensure clicking anywhere inside the tile works
    if (!li) return;

    currentSongIndex = parseInt(li.getAttribute("data-index"));
    currentSection = li.getAttribute("data-section");
    const songTitle = li.getAttribute("data-title");
    const songArtist = li.getAttribute("data-artist");
    const songCover = li.getAttribute("data-cover");
    const songURL = li.getAttribute("data-url");

    playSong(songTitle, songArtist, songCover, songURL);
}

// 🎵 Play Song function

function playSong(title, artist, cover, url) {
    if (!url) {
        console.error("❌ Error: Song URL missing for:", title);
        return;
    }

    // ✅ Fetch the username from localStorage (Modify if username is stored elsewhere)
    let username = localStorage.getItem("loggedInUser"); 

    if (!username) {
        console.error("❌ Error: No username found! Cannot update last played.");
        return;
    }

    console.log(`🎵 Song Play Call Initiated for ${username}: ${title}`);
    
    audioPlayer.src = url;
    audioPlayer.load();
    audioPlayer.play()
        .then(() => {
            console.log(`✅ Now playing: ${title}`);
            updateMediaSession(title, artist, cover);
            saveAndUpdateLastPlayed(username, title); // ✅ Pass username properly
        setTimeout(updateLastListenedWidget, 1000); // Fetch updated data after saving
        })
        .catch(err => console.error("❌ Playback error:", err));

    audioPlayer.onended = () => playNext();
}


// 🔥 Update Last Played Song in JSONBin
function saveAndUpdateLastPlayed(username, songName) {
    if (!username) {
        console.error("❌ Error: No username provided! Skipping update.");
        return;
    }

    console.log(`🎵 Saving last played song for ${username}: ${songName}`);

    // Get existing data from localStorage
    let data = localStorage.getItem("lastPlayedSongs");
    let parsedData = data ? JSON.parse(data) : { users: {} };

    // Prevent unnecessary updates (avoid infinite loop)
    if (parsedData.users[username] && parsedData.users[username].lastPlayed === songName) {
        console.log("🔁 No change detected. Skipping update.");
        return;
    }

    // Update user's last played song
    parsedData.users[username] = { lastPlayed: songName };

    // Save updated data to localStorage
    localStorage.setItem("lastPlayedSongs", JSON.stringify(parsedData));
    console.log("✅ Data saved in localStorage:", parsedData);

    // Update JSONBin
    fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json",
            "X-Master-Key": API_KEY
        },
        body: JSON.stringify(parsedData)
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log(`✅ JSONBin update success! Last played for ${username}: ${songName}`);
    })
    .catch(error => console.error("❌ JSONBin update failed:", error));
}

function updateLastListenedWidget() {
    console.log("🔄 Fetching Last Listened Song from JSONBin...");

    fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        method: "GET",
        headers: { "X-Master-Key": API_KEY }
    })
    .then(response => response.json())
    .then(data => {
        let username = localStorage.getItem("loggedInUser");
        if (!username || !data.record.users || !data.record.users[username]) {
            console.log("❌ No last played song found for user.");
            return;
        }

        let lastSong = data.record.users[username].lastPlayed;
        console.log(`✅ Last Played Song: ${lastSong}`);

        // **Flatten the database**
        let flattenedDatabase = [];
        Object.values(database).forEach(category => {
            flattenedDatabase = flattenedDatabase.concat(category);
        });

        // **Find the matching song in the database**
        let songData = flattenedDatabase.find(song => song.title?.trim().toLowerCase() === lastSong.trim().toLowerCase());

        // **Get cover from database or fallback to placeholder**
        let coverUrl = songData ? songData.cover : "placeholder.jpg";
        console.log(`✅ Cover URL Found: ${coverUrl}`);

        // **Update the Widget UI**
        let titleElement = document.getElementById("last-listened-title");
        let coverElement = document.getElementById("last-listened-cover");

        if (!titleElement || !coverElement) {
            console.error("❌ Widget Elements Not Found! Retrying in 1s...");
            setTimeout(updateLastListenedWidget, 1000);
            return;
        }

        titleElement.textContent = lastSong;
        coverElement.src = coverUrl;
        coverElement.style.width = "64px";
        coverElement.style.height = "64px";

        console.log("✅ Widget Successfully Updated!");
    })
    .catch(error => console.error("❌ JSONBin Fetch Failed:", error));
}

// 🔥 Update Media Session API
function updateMediaSession(title, artist, cover) {
    if ("mediaSession" in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: title,
            artist: artist || "Unknown Artist",
            artwork: [{ src: cover, sizes: "512x512", type: "image/png" }]
        });

        navigator.mediaSession.setActionHandler("play", () => audioPlayer.play());
        navigator.mediaSession.setActionHandler("pause", () => audioPlayer.pause());
        navigator.mediaSession.setActionHandler("nexttrack", () => playNext());
        navigator.mediaSession.setActionHandler("previoustrack", () => playPrevious());
    }
}


// 🔥 Play Next Song
function playNext() {
    const songList = database[currentSection] || [];
    currentSongIndex = (currentSongIndex + 1) % songList.length;
    const nextSong = songList[currentSongIndex];
    playSong(nextSong.title, nextSong.artist, nextSong.cover, nextSong.url);
}

// 🔥 Play Previous Song
function playPrevious() {
    const songList = database[currentSection] || [];
    currentSongIndex = (currentSongIndex - 1 + songList.length) % songList.length;
    const prevSong = songList[currentSongIndex];
    playSong(prevSong.title, prevSong.artist, prevSong.cover, prevSong.url);
}



// 🚀 Initialize Everything on Page Load
document.addEventListener("DOMContentLoaded", function () {
    populateFeaturedMusic();
});



document.querySelectorAll("a").forEach(link => {
    let originalUrl = link.href;

    // Check if the URL is prefixed with Wayback Machine's domain
    if (originalUrl.startsWith("https://web.archive.org/web/")) {
        // Extract the actual URL after the Wayback Machine prefix
        let cleanedUrl = originalUrl.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, '');

        // Set the cleaned URL back
        link.href = cleanedUrl;
    }
});


// Function to switch tabs
function showTab(tabID) {
    var allSections = document.querySelectorAll(".scrollPanel");
    allSections.forEach(section => section.style.display = "none"); // Hide all

    var activeSection = document.getElementById(tabID);
    if (activeSection) activeSection.style.display = "block"; // Show selected
}

document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("a").forEach(link => {
        let originalUrl = link.href;

        if (originalUrl.includes("web.archive.org/web/")) {
            // Extract the real URL by removing the Wayback prefix
            let cleanedUrl = originalUrl.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");

            // Forcefully override any hijacked links
            link.href = cleanedUrl;
            link.setAttribute("data-fixed", "true"); // Just to mark it's fixed
        }
    });

    // Extra Protection: Stop Wayback from injecting back in
    setInterval(() => {
        document.querySelectorAll("a").forEach(link => {
            if (link.href.includes("web.archive.org/web/")) {
                link.href = link.href.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");
            }
        });
    }, 500); // Runs every 500ms to keep checking
});

document.addEventListener("click", function (event) {
    let target = event.target.closest("a"); // Check if a link was clicked
    if (target && target.href.includes("web.archive.org/web/")) {
        event.preventDefault(); // Stop default action
        let cleanedUrl = target.href.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");
        window.location.href = cleanedUrl; // Redirect manually
    }
});

document.addEventListener("DOMContentLoaded", function () {
    function fixWaybackLinks() {
        document.querySelectorAll("a").forEach(link => {
            if (link.href.includes("web.archive.org/web/")) {
                link.href = link.href.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");
            }
        });
    }

    // Run fix on page load
    fixWaybackLinks();

    // Watch for new elements being added (Wayback reinjects links dynamically)
    const observer = new MutationObserver(fixWaybackLinks);
    observer.observe(document.body, { childList: true, subtree: true });

    // Block clicks that still contain Wayback URLs
    document.addEventListener("click", function (event) {
        let target = event.target.closest("a");
        if (target && target.href.includes("web.archive.org/web/")) {
            event.preventDefault(); // Stop default action
            let cleanedUrl = target.href.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");
            window.location.href = cleanedUrl; // Redirect manually
        }
    });
});

(function () {
    function cleanWaybackLinks() {
        document.querySelectorAll("a").forEach(link => {
            if (link.href.includes("web.archive.org/web/")) {
                let cleanedUrl = link.href.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");
                link.setAttribute("href", cleanedUrl);
            }
        });
    }

    // 1️⃣ Block Wayback at the document level (injected early)
    Object.defineProperty(document, 'URL', {
        get: function () {
            return window.location.href.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");
        }
    });

    // 2️⃣ Override any future changes to links
    const observer = new MutationObserver(cleanWaybackLinks);
    observer.observe(document.body, { childList: true, subtree: true });

    // 3️⃣ Intercept and fix links before navigation happens
    document.addEventListener("click", function (event) {
        let target = event.target.closest("a");
        if (target && target.href.includes("web.archive.org/web/")) {
            event.preventDefault();
            let cleanedUrl = target.href.replace(/https:\/\/web\.archive\.org\/web\/\d+\//, "");
            window.location.href = cleanedUrl;
        }
    });

    // Run cleanup immediately
    cleanWaybackLinks();
})();

document.addEventListener("DOMContentLoaded", function() {
    console.log("Search page loaded...");

    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get("query");

    console.log("Query received:", query);

    if (query) {
        handleSearch(query);
    } else {
        console.error("No search query found!");
    }
});

function handleSearch(query) {
    console.log("Handling search for:", query);

    if (typeof database === "undefined") {
        console.error("Error: database is not defined in script.js!");
        return;
    }

    const searchResults = document.getElementById("searchResults").querySelector("ul");
    if (!searchResults) {
        console.error("Error: searchResults element not found!");
        return;
    }

    searchResults.innerHTML = ""; // Clear previous results

    const filteredSongs = database.filter(song =>
        song.title.toLowerCase().includes(query.toLowerCase()) ||
        song.artist.toLowerCase().includes(query.toLowerCase())
    );

    if (filteredSongs.length === 0) {
        searchResults.innerHTML = "<li>No results found</li>";
        return;
    }

    filteredSongs.forEach((song) => {
        const li = document.createElement("li");
        li.innerHTML = `
            <div class="song">
                <img src="${song.cover}" alt="Cover Image">
                <strong>${song.title}</strong>
                <p>${song.artist}</p>
                <button class="play-btn" data-src="${song.src}" data-title="${song.title}" data-artist="${song.artist}" data-cover="${song.cover}">▶ Play</button>
            </div>
        `;
        searchResults.appendChild(li);
    });

    console.log("Results added:", searchResults.innerHTML);

    document.querySelectorAll(".play-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
            const songSrc = this.getAttribute("data-src");
            const songTitle = this.getAttribute("data-title");
            const songArtist = this.getAttribute("data-artist");
            const songCover = this.getAttribute("data-cover");
            
            playSong(songSrc, songTitle, songArtist, songCover);
        });
    });
}



/*function handleSearch(query) {
    // 1. Gather matching songs from all categories
    const results = [];
    for (const category in database) {
      database[category].forEach(song => {
        const textToMatch = (song.title + song.artist).toLowerCase();
        if (textToMatch.includes(query.toLowerCase())) {
          results.push(song);
        }
      });
    }
  
    // 2. Display the results in some container (e.g. <div id="searchResults"></div>)
    const resultsContainer = document.getElementById("searchResults");
    if (!resultsContainer) {
      console.warn("No #searchResults element found in the DOM.");
      return;
    }
  
    // Clear old results
    resultsContainer.innerHTML = "";
  
    if (results.length === 0) {
      resultsContainer.textContent = "No matches found.";
      return;
    }
  
    // 3. Show each matching song as a clickable item
    results.forEach((song, index) => {
      const songDiv = document.createElement("div");
      songDiv.classList.add("search-result");
      songDiv.innerHTML = `<strong>${song.title}</strong> by ${song.artist}`;
      
      // Clicking on a result starts playback
      songDiv.addEventListener("click", () => {
        playSongFromSearch(results, index);
      });
      resultsContainer.appendChild(songDiv);
    });
  }
  
  /**
   * Audio player used for playing search results
   */
  //let searchAudio = new Audio();
  
  /**
   * Plays a specific song from the given array of songs.
   * @param {Array} songs - The list of matching songs.
   * @param {number} index - Which song in the array to play.
   */
 /* function playSongFromSearch(songs, index) {
    if (index < 0 || index >= songs.length) return;
  
    const songData = songs[index];
    searchAudio.src = songData.url;
    searchAudio.play();
  
    // Optional: Update Media Session (for mobile lock-screen controls, etc.)
    if ("mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: songData.title,
        artist: songData.artist,
        album: "Nuvi Music",
        artwork: [
          {
            src: songData.cover || "images/default-cover.jpg",
            sizes: "512x512",
            type: "image/jpeg"
          }
        ]
      });
  
      navigator.mediaSession.setActionHandler("play", () => searchAudio.play());
      navigator.mediaSession.setActionHandler("pause", () => searchAudio.pause());
      navigator.mediaSession.setActionHandler("nexttrack", () => {
        if (index + 1 < songs.length) playSongFromSearch(songs, index + 1);
      });
      navigator.mediaSession.setActionHandler("previoustrack", () => {
        if (index - 1 >= 0) playSongFromSearch(songs, index - 1);
      });
    }
  
    // Autoplay the next track when the current one ends
    searchAudio.onended = function () {
      if (index + 1 < songs.length) {
        playSongFromSearch(songs, index + 1);
      }
    };
  }*/
  
  /**
   * Example usage: If you also want to show some 'top' songs on page load,
   * you could do something like this:
   */
 /* document.addEventListener("DOMContentLoaded", () => {
    // For example, automatically list all songs in 'top' category
    // handleSearch(''); // or handleSearch with some default text
  });*/

  document.addEventListener("DOMContentLoaded", function () {
    const loginPane = document.querySelector(".bg-white");
    const loginButton = document.querySelector("button");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const registerLink = document.querySelector("a[href='#'][class='font-bold text-white']");
    
    const JSONBIN_ID = "67ca7dcaad19ca34f817f025";
    const API_KEY = "$2a$10$IG0fCGUHCL7iFsZMFQjI4e4ufPung048BrnWjddZBoo5V3UjUQ4ja";
    
    // Fade-in animation
    loginPane.style.opacity = "0";
    loginPane.style.transform = "translateY(-20px)";
    setTimeout(() => {
        loginPane.style.transition = "opacity 0.5s ease-out, transform 0.5s ease-out";
        loginPane.style.opacity = "1";
        loginPane.style.transform = "translateY(0)";
    }, 100);
    
    loginButton.addEventListener("click", async function (e) {
        e.preventDefault();
        
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        
        // Check for empty fields
        if (!username || !password) {
            if (!username) usernameInput.classList.add("ring-2", "ring-red-500");
            if (!password) passwordInput.classList.add("ring-2", "ring-red-500");
            return;
        }
        
        // Signing in animation
        loginPane.innerHTML = "<h2 class='text-2xl font-bold text-white text-center mb-6'>Signing You In...</h2>";
        loginPane.style.transform = "translateY(-20px)";
        setTimeout(() => {
            loginPane.style.transition = "transform 0.5s ease-in-out";
            loginPane.style.transform = "translateY(0)";
        }, 500);
        
        try {
            const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`, {
                headers: { 'X-Master-Key': API_KEY }
            });
            const data = await response.json();
            const users = data.record.users;
            
            if (users[username] && users[username].password === password) {
                localStorage.setItem("loggedInUser", username);
                window.location.href = `pc.html?user=${encodeURIComponent(username)}`;
            } else {
                loginPane.innerHTML = `
                    <h2 class='text-2xl font-bold text-white text-center mb-6'>Login</h2>
                    <img src='./images/error.gif' class='mx-auto' alt='Error'>
                    <p class='text-white text-center mt-4'>Incorrect Username or Password</p>
                    <button id='retry-button' class='w-full py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-300 mt-4'>Retry</button>
                `;
                document.getElementById("retry-button").addEventListener("click", () => location.reload());
            }
        } catch (error) {
            console.error("Error fetching credentials:", error);
            alert("Login system error. Try again later.");
        }
    });
});
   /* document.addEventListener("DOMContentLoaded", function () {
        // Your declared variables
        const loginPane = document.querySelector(".bg-white");
        const loginButton = document.querySelector("button");
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const registerLink = document.querySelector("a[href='#'][class='font-bold text-white']");
    
        // JSONBin Credentials
        const JSONBIN_ID = "67ca7dcaad19ca34f817f025";
        const API_KEY = "$2a$10$IG0fCGUHCL7iFsZMFQjI4e4ufPung048BrnWjddZBoo5V3UjUQ4ja";
        const apiUrl = `https://api.jsonbin.io/v3/b/${JSONBIN_ID}`;
    
        // **Detect which button is clicked**
        document.body.addEventListener("click", function (event) {
            if (event.target.id === "register-link") {
                event.preventDefault();
                transitionToRegister();
            } else if (event.target.id === "submit-register") {
                event.preventDefault();
                validateAndRegister();
            }
        });
    
        // **Register Pane Transition**
        function transitionToRegister() {
            loginPane.style.transform = "translateX(-100%)";
            setTimeout(() => {
                loginPane.innerHTML = `
                    <h2 class="text-2xl font-bold text-white text-center mb-6">Register With Nuvi</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <input class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-white focus:outline-none focus:ring-2 focus:ring-purple-500" type="text" id="reg-username" placeholder="Username">
                        </div>
                        <div class="mb-4">
                            <input class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-white focus:outline-none focus:ring-2 focus:ring-purple-500" type="email" id="reg-email" placeholder="Email">
                        </div>
                        <div class="mb-4">
                            <input class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-white focus:outline-none focus:ring-2 focus:ring-purple-500" type="password" id="reg-password" placeholder="Password">
                        </div>
                        <button id="submit-register" class="w-full py-3 bg-white text-purple-900 font-bold rounded-lg hover:bg-gray-200 transition duration-300">Register</button>
                    </form>
                `;
                loginPane.style.transform = "translateX(0%)";
            }, 500);
        }
    
        // **Validation & Registration Process**
    document.getElementById("register-btn").addEventListener("click", async function() {
        await validateAndRegister();
    });

    async function validateAndRegister() {
        const username = document.getElementById("reg-username").value.trim();
            const email = document.getElementById("reg-email").value.trim();
            const password = document.getElementById("reg-password").value.trim();
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    
            if (!username || !email || !password) {
                alert("All fields are required!");
                return;
            }
            if (!emailRegex.test(email)) {
                alert("Enter a valid email (example@mail.com)");
                return;
            }
    
            showLoadingScreen();
    
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`, {
                    method: 'GET',
                    headers: { 'X-Master-Key': API_KEY }
                });
                const data = await response.json();
                let users = data.record.users;
                
                if (users[username]) {
                    alert("Username already exists!");
                    return;
                }
                
                users[username] = { email, password };
                
                await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'X-Master-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ users })
                });
            } catch (error) {
                alert("Error registering. Try again!");
                console.error(error);
                transitionToRegister();
            }
        }
    
            .then(response => response.json())
            .then(() => showSuccessScreen())
            .catch(error => {
                alert("Error registering. Try again!");
                console.error(error);
                transitionToRegister();
            });*/
        
    
        // **Loading Screen Animation**
        function showLoadingScreen() {
            loginPane.style.transform = "translateX(-100%)";
            setTimeout(() => {
                loginPane.innerHTML = `
                    <div class="text-center">
                        <img src="loading.gif" alt="Loading..." class="mx-auto w-16">
                        <p class="text-white mt-4">Registering Please Wait...</p>
                    </div>
                `;
                loginPane.style.transform = "translateX(0%)";
            }, 500);
        }
    
        // **Success Screen Transition**
        function showSuccessScreen() {
            loginPane.style.transform = "translateX(-100%)";
            setTimeout(() => {
                loginPane.innerHTML = `
                    <div class="text-center">
                        <img src="success.gif" alt="Success" class="mx-auto w-16">
                        <p class="text-white mt-4">Registration Success. You will be taken to Login section now</p>
                    </div>
                `;
                loginPane.style.transform = "translateX(0%)";
            }, 500);
    
            setTimeout(() => location.reload(), 3000);
        }

        validateAndRegister();
  //  });
    
    
    
    // Store last listened song
    document.addEventListener("DOMContentLoaded", function () {
        const loggedInUser = localStorage.getItem("loggedInUser");
        if (loggedInUser) {
            const lastSong = localStorage.getItem(`${loggedInUser}_lastSong`);
            if (lastSong) {
                console.log("Last listened song:", lastSong);
            }
        }
    });
    
    // Function to update last listened song
    function updateLastSong(songName) {
        const loggedInUser = localStorage.getItem("loggedInUser");
        if (loggedInUser) {
            localStorage.setItem(`${loggedInUser}_lastSong`, songName);
        }
    }
//});

document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const usernameFromURL = urlParams.get("user");
    const loggedInUser = localStorage.getItem("loggedInUser") || usernameFromURL;
    const loginSection = document.getElementById("login-section");

    if (!loginSection) return;

    // Create a wrapper container
    let containerDiv = document.createElement("div");
    containerDiv.classList.add("container"); // ✅ Add container class

    if (loggedInUser) {
        const lastSong = localStorage.getItem(`${loggedInUser}_lastSong`) || "No recent songs";
        containerDiv.innerHTML = `
            <p>Welcome, <strong>${loggedInUser}</strong>!</p>
            <p>Last listened: <em>${lastSong}</em></p>
            <button id='logout' style='margin-top:10px; padding:8px 15px; background:red; color:white; border:none; border-radius:5px; cursor:pointer;'>Logout</button>
        `;
    } else {
        containerDiv.innerHTML = `
            <h2>Welcome to Symphonia Desktop</h2>
            <p>Please log in to continue.</p>
            <button id='login-btn' style='margin-top:10px; padding:10px 20px; background:blue; color:white; border:none; border-radius:5px; cursor:pointer;'>Login</button>
        `;
    }

    // Clear previous content and append the wrapped container
    loginSection.innerHTML = "";
    loginSection.appendChild(containerDiv);

    // Attach event listeners AFTER inserting into the DOM
    if (loggedInUser) {
        document.getElementById("logout").addEventListener("click", function () {
            localStorage.removeItem("loggedInUser");
            window.location.href = "pc.html"; // Redirect to login page
        });
    } else {
        document.getElementById("login-btn").addEventListener("click", function () {
            window.location.href = "login.html";
        });
    }
});


// Function to track and store last listened song
function trackLastPlayed(songTitle, songArtist, songCover, songUrl) {
    const lastPlayed = {
        title: songTitle,
        artist: songArtist,
        cover: songCover,
        url: songUrl
    };
    localStorage.setItem('lastPlayed', JSON.stringify(lastPlayed));
}

// Function to retrieve last played song
function getLastPlayed() {
    const lastPlayed = localStorage.getItem('lastPlayed');
    return lastPlayed ? JSON.parse(lastPlayed) : null;
}

// Display last played song in UI
document.addEventListener("DOMContentLoaded", function () {
    const lastPlayed = getLastPlayed();
    if (lastPlayed) {
        console.log("Last played song:", lastPlayed);
        // You can update the UI with last played song details here
        document.getElementById("lastPlayedTitle").textContent = lastPlayed.title;
        document.getElementById("lastPlayedArtist").textContent = lastPlayed.artist;
        document.getElementById("lastPlayedCover").src = lastPlayed.cover;
    }
});
document.addEventListener("DOMContentLoaded", function () {
    const loginButton = document.getElementById("lgn-btn");

    // Check if user is already logged in
    const loggedInUser = localStorage.getItem("loggedInUser");

    if (loggedInUser) {
        loginButton.textContent = loggedInUser; // Change button text to username
        loginButton.addEventListener("click", function (event) {
            event.preventDefault();
            alert("Please Press Dashboard Button to access Info.");
        });
    } else {
        // Redirect to login page when clicked if not logged in
        loginButton.addEventListener("click", function () {
            window.location.href = "./register.html";
        });
    }
});
